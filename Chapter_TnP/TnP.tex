\newcommand{\ID}{\text{ID}}
\newcommand{\Prompt}{\text{Prompt}}
\newcommand{\Isolated}{\text{Isolated}}
\newcommand{\Gold}{\text{Gold}}
\newcommand{\Silver}{\text{Silver}}
\newcommand{\Bronze}{\text{Bronze}}


\newcommand\FigureOne[3]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#1}\hfill
\caption{#2}
\label{#3}
\end{figure}}


\newcommand\FigureFour[6]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#1}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#2}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#3}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#4}\hfill
\caption{#6}
\label{#5}
\end{figure}}

\newcommand\FigureThree[5]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.4\textwidth]{fig/Lep_Obj_plots/#1}
\includegraphics[width=0.4\textwidth]{fig/Lep_Obj_plots/#2}\hfill
\includegraphics[width=0.4\textwidth]{fig/Lep_Obj_plots/#3}\hfill
\caption{#4}
\label{#5}
\end{figure}}

\newcommand\FigureTwo[4]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#1}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#2}\hfill
\caption{#4}
\label{#3}
\end{figure}}

\newcommand\FigureStack[4]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.75\textwidth]{fig/Lep_Obj_plots/#1}\hfill\\
\includegraphics[width=0.75\textwidth]{fig/Lep_Obj_plots/#2}\hfill
\caption{#4}
\label{#3}
\end{figure}}

\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}
\setlength{\parskip}{\smallskipamount}
\setlength{\parindent}{0pt}


\makeatletter


\providecommand{\tabularnewline}{\\}


\makeatother

%\usepackage{babel}
%\begin{document}

\chapter{Lepton Selection and Efficiency Measurement}

%\begin{chapterabstract}
%The Tag-and-Probe is a method used to measure the selection efficiencies of an object using data. In the context of this compressed SUSY %analysis, the Tag-and-probe measures the efficiencies separately of each light lepton($e/\mu$) selection critera. The total lepton selection %efficiency is then computed by combining factorized efficiency components. The same general method is used for both electrons and muons, %however, Muons utilize  the $J/\psi$ di-muon trigger which allow more precise efficiency measurements from data at lower $p_T$.
%\end{chapterabstract}
\section{Lepton Object Definitions}


Electrons and muons are selected according to the minimum requirement ``VeryLoose'' which depends on kinematic and topological quantities in Table \ref{tab:veryloose}. The electrons use an additional loose requirement, the MVA VLooseFO Id \cite{elecMVA}. The set of VeryLoose leptons are further subdivided by quality into three mutually exclusive categories: Gold, Silver, and Bronze. Each category has a measure of three main quantities, the first is the quality of the pre-determined Id. The Id's differ per flavor and are the standard working points defined by the corresponding physics object group.  Id's range from Loose to Medium to Tight and gain stricter requirements for each tighter requirement. The Loose Id has the highest selection efficiency and misidentification rate while the Tight Id is the least efficient and has the lowest misidentification rate. The muons use the Medium Id \cite{muMediumId} and electrons use a more strict selection with the Tight Id \cite{eTightID}. The second quantity is the ``promptness'' or distance of the lepton production point from the primary vertex. Promptness is measured by the significance of the 3D impact parameter (SIP3D) defined as the impact parameter normalized by its measured error. The impact parameter is the distance of the track's point of closest approach to the primary vertex. There are three relevant impact parameters, $d_{xy}$, $d_{z}$, and $IP_{3D}$. The first two parameters, $d_{xy}$ and $d_{z}$ are the distance in the $x-y$ and $r-z$ planes, respectively. $IP_{3D}$ is the three dimensional distance from the primary vertex to track's point of closest approach.  All three impact parameters are signed based on the same convention. For a track with direction $\hat{t}$ and distance vector $\hat{d}$ directed from the primary vertex to point of closes approach, the sign of the impact parameter follows $\hat{t}\cdot\hat{d}$.  The last component is isolation, a measure of the density of particles in a cone around the lepton. Two similar but complimentary absolute isolations are used: PFIso \cite{murun2baseline} and MiniIso \cite{miniIso}. Both isolations are an energy sum of neighboring particles inside a cone, but, PFIso has a fixed cone size of $R=0.4$ cm. PFIso is defined in Equation \ref{pfiso} where $p_{T,\text{ch. had} }^{PV}$ is the transverse momentum of tracks associated with the primary vertex that are inside the cone, $E_{T,\text{neut. had}}$ is the transverse energy from energy deposits not associated with tracks that are inside the cone, and $p_{T, \text{ch. had}}^{PU}$ is the transverse momentum of tracks not associated with the primary vertex that are inside the cone. Unlike PFIso, MiniIso uses the same cone-based particle summation strategy, but the cone sizes varies inversely with lepton \pt as shown in Equation \ref{isoeq}.

\begin{equation}\label{pfiso}
\sum p_{T,\text{ch. had} }^{PV} + \text{max}(0, \sum E_{T,\text{neut. had}}) - 0.5*\sum p_{T, \text{ch. had}}^{PU}
\end{equation}

\begin{equation}
R_{\text{miniIso}}=
    \begin{cases}
      0.2 & \pt^\ell < 50 \text{GeV}\\
      \frac{10}{\pt^\ell} & 50 \text{GeV} \leq \pt^\ell \leq 200 \text{GeV} \\
      0.05 & \pt^\ell > 200 \text{GeV}
    \end{cases}
    \label{isoeq}
\end{equation}


%Mini isolation also includes effective area pile-up corrections provided in a look up table of bins of \pt and $\eta$ in the CMSSW Producer/Ntuplizing stage. The implementation of mini-isolation and their corrections utilize the same IsoValueMap producer as used in NANO AOD as of \url{CMSSW_10_6_X}.


The explicit flavor independent formulas for Gold, Silver, and Bronze can be generalized by the product of three components which are the measured efficiencies of the three previously mentioned quantities. The efficiencies take the form of conditional probabilities to be measured independently in sequence relative to each other:
\begin{equation}\label{eq:efflep_general}
\begin{split}
\epsilon_{\Gold}& = \epsilon_{\ID}\times \epsilon_{\Isolated|\ID} \times \epsilon_{\Prompt|(\ID \cap \Isolated)} \\
\epsilon_{\Silver}& = \epsilon_{\ID} \times \epsilon_{\Isolated|\ID} \times (1-\epsilon_{\Prompt|(\ID \cap \Isolated)}) \\
\epsilon_{\Bronze}& = 1-(\epsilon_{\ID} \times \epsilon_{\Isolated|\ID)} )
\end{split}
\end{equation}

The subscript for an efficiency, e.g. $\epsilon_{\Prompt|(\ID \cap \Isolated)}$, reads as the efficiency to pass the SIP3D requirement given the lepton passes the Id and Isolation requirements. From equation \ref{eq:efflep_general} the Gold, Silver, and Bronze efficiencies can be read off as Gold passes all criteria, Silver fails only the SIP3D requirement, and Bronze fails either the Id or isolation and is agnostic to SIP3D. While isolation and vertexing requirements are physically uncorrelated, there is an intersection between the two, meaning a lepton can be both prompt and isolated. This intersection then demands the necessity for conditional efficiencies.  The order of the conditional efficiencies is also chosen to minimize the number of measured efficiencies by reusing efficiencies across Gold, Silver, and Bronze.  





\begin{table}[htbp]
\centering
\caption{\label{tab:veryloose} The criteria that define the minimum requirements for an accepted lepton. The electron and muon requirements are equivalent in terms of pseudo-rapidity, vertexing, and isolation but vary in \pt threshold and the MVA VLooseFO working point. The MVA VLooseFO ID also varies between years. The parameters $d_{xy}$ and $d_{z}$ are the transverse and longitudinal impact parameters, respectively.}

\begin{tabular}{c|c|c}
\hline
Criteria & Electron & Muon \\
\hline
\hline
\pt & $\geq 5$ GeV & $\geq 3$ GeV \\

$|\eta|$ & $<2.4$ & $<2.4$ \\
\hline

$\text{IP}_{3D}/\sigma_{\text{IP}_{3D}}$ & $<8$ & $<8$ \\

$|d_{xy}|$ & $<0.05$ cm & $<0.05$ cm \\

$|d_z|$ & $<0.1$ cm & $<0.1$ cm \\

\hline
$\text{PFIso}_{\text{abs}}$ & $<20 + (300/\pt)$ GeV & $<20 + (300/\pt)$ GeV \\

\hline
MVA VLooseFO ID & \checkmark  & --\\
\end{tabular}
\end{table}


The advantage of having multiple lepton quality categories allows for robust sensitivity to a wide range of signal processes. This strategy boosts the overall statistics and provides control regions for multiple scenarios. %but also provide fake rich selection in control region that helps stabilize the overall fit and extract fake rates into the sensitive regions.  
The populations of different truth matched objects per quality are shown in Figure \ref{andresPurity} and the MC efficiency for Gold, Silver, and Bronze with truth matched objects is shown in Figure \ref{andresEff}.  The Gold region is mainly populated by prompt and isolated leptons that are produced within the primary vertex. This region also coincides with the signature of many targeted electroweakino models. The Silver selection accommodates both leptonically decaying taus, providing an ideal region for stau's, and assists in recovering efficiency of isolated b decays. The Bronze selection is rich in fake leptons and provides the best regions to extract fake rates and anchor the fit through a surplus of events. 



\FigThreeScale{Lep_Obj_plots/gold_ele_TTJets_Fall17.pdf}{Lep_Obj_plots/silver_ele_TTJets_Fall17.pdf}{Lep_Obj_plots/bronze_ele_TTJets_Fall17.pdf}{Gold (Top-Left), Silver (Top-Right) and Bronze (Bottom) MC truth matching in $t\bar{t}$ sample for 2017. Each figure demonstrates the MC truth composition of each electron quality where a reconstructed electron is $\Delta R$ matched to a either a signal electron from a prompt $W$ boson decay, a leptonic tau decay, b-quark jet, c-quark jet, or light quark jet \cite{AN}.}{andresPurity}{0.49}{0.49}{0.49}


\FigTwoScale{Lep_Obj_plots/sigEff_ele_TTJets_Fall17.pdf}{Lep_Obj_plots/sigEff_mu_TTJets_Fall17.pdf}{Gold, Silver, and Bronze efficiency on truth matched prompt signal leptons from $W$ bosons in tt+jets. The fake efficiencies are also shown for each lepton quality with leptons truth matched to any other source \cite{AN}.}{andresEff}{0.49}{0.49}


\FloatBarrier

\section{Tag-and-Probe Methodology}
An important element of a lepton based search is properly modeling the efficiency of selected leptons. A purely Monte-Carlo driven approach is inadequate in perfectly describing nuances in data due to imperfections in modeling. Instead of trying to model exactly all physics and detector effects with simulation, the efficiencies can be directly measured from data by using the Tag-and-Probe method. Then the efficiency ratio between data and MC can be used to multiply the MC as calibration to match data. 

The Tag-and-Probe method is used to measure lepton selection criteria by using a well known resonance such as a $Z$, $J/\psi$, or $\Upsilon$ and counting the number of probes that pass that criteria. Each counted instance of the Tag-and-Probe consists of two selected leptons. One of the selected leptons is the tag and the other is the probe.  The tag passes tight selection requirement to give high confidence that it isn't a fake lepton. Fake leptons fall into two possible categories: reducible and irreducible. A reducible fake lepton is a particle that fakes the signature of a lepton such as a charged pion. An irreducible fake lepton is an actual lepton which coincidentally passes some selection criteria but is not the targeted leptons of interest e.g. an isolated muon from a jet accompanying a leptonic Z decay of interest.  The  second lepton in the Tag-and-Probe is the probe. The probe is subjected to the selection criteria whose efficiency is being measured. The invariant mass of the pair of leptons is calculated and required to fall within a defined range around the resonance. A particular event may have multiple lepton pairs but the tag and the probe are not allowed to switch positions and be counted twice, as double counting would lead to a bias in the efficiency measurement \cite{AN111-2009}. To avoid bias, the tag and probe are required to be the opposite charge and same flavor where the tag is randomly selected. If multiple same flavor lepton pairs occur in single event i.e. there are multiple probes to a single tag, the treatment for selecting the pairs differs between electrons and muons. There is no specific study which led to justifying the differing arbitration approaches in flavors, only that the choice reflects the default choices implemented in the existing code bases.  For muons, no arbitration is used, all pairs are utilized which means an additional pair not truly from the resonance will then contribute as combinitorial background in a single event. For electrons, only a single probe is selected per event which has the highest \pt. The selected probes can either pass or fail their selection which leads to the formation of three distributions, one with a passing probe, one with a failing probe, and one with all probes. An example of all three distributions is shown in Figure \ref{tnpexp}.  The probability of observing $k$ passing probes in $n$ Tag-and-Probe pair trials is dependent on the selection efficiency $\varepsilon$ and can be expressed as a likelihood from the binomial probability density $P(k|\varepsilon,n) = \binom{n}{k}\varepsilon^k(1-\varepsilon)^{n-k}$. The MLE estimator for efficiency is then the fraction of passing probes to the total number of pairs, or $\varepsilon = k/n$. Technical documentation for the Tag-and-Probe in CMS is scarce, but, an early strategy for fitting efficiency is defined in \cite{Berryhill_2010}. The legacy code base as of \url{CMSSW_10_6_X}  uses a binned maximum likelihood between the observed passing probes and failing probes where the efficiency extracted is an explicit fit parameter. The two simultaneously fit functions are:
\begin{equation}
	N^{\text{Pass}} = N_{\text{Total}} (\varepsilon \cdot f^{\text{sig}}_{\text{All}} ) +  \varepsilon_{\text{bkg}} \cdot (1-f^{\text{sig} }_{\text{All}}) )
\end{equation} 
\begin{equation}
	N^{\text{Fail}} = N_{\text{Total}} ( (1-\varepsilon) \cdot f^{\text{sig}}_{\text{All}} +   (1-\varepsilon_{\text{bkg}}) \cdot (1-f^{\text{sig}}_{\text{All}}) )
\end{equation}

$N^{\text{Pass/Fail}}$ is the total number of observed probes that either pass or fail the selection criteria while $N_{\text{Total}}$ is the total number of Tag-and-Probe pairs.
The binomial estimator for efficiency, $\varepsilon$, enters the fit functions as the first term but is accompanied by a second term that describes the background contribution with its own efficiency $\varepsilon_{\text{bkg}}$.  The term $f^{\text{sig}}_{\text{All}}$ is the fraction of background subtracted signal events over the allowed dilepton mass range.  $f^{\text{sig}}_{\text{All}}$ depends on the defined signal and background pdfs. The nominal pdfs chosen for reported fits uses a 5 parameter Voigtian+Voigtian signal model which share a common mean but use independent width parameters, in conjunction with an Exponential background model. 


\FigureThree{PassingProbes_Med16_lowpt.png}{FailingProbes_Med16_lowpt.png}{AllProbes_Med16_lowpt.png}{Example Tag-and-Probe Z di-muon fits for passing,failing, and all probes with the Medium Id, $|\eta|<1.2$, and $p_T < 20$ GeV   }{tnpexp}



%The distributions are fit simultaneously with a combined signal and background model. To extract the probe criteria efficiecy we divide the resonance distributions by the all probes distribution. The uncertainty on an efficiency is a combination of a statistical and systematic uncertainties. The systematic uncertainties are defined by repeating the simultaneous fit with varying mass windows, number of bins, and fit models and measuring the maximum spread of the central values.


%The fit code is located here: \url{https://github.com/cms-sw/cmssw/blob/CMSSW_10_6_X/PhysicsTools/TagAndProbe/src/TagProbeFitter.cc} around line 600. confirm this with the fit model from the electron paper. \cite{Berryhill_2010}

\FloatBarrier

\section{The Electron Tag-and-Probe }

The electron Tag-and-Probe is performed with the $Z$ resonance over a range of bins divided by $p_T$ and $\eta$. The selected binnings follow the $\pt$ and $\eta$ binning conventions from the electron physics object group and are $ p_T \in [5, 10, 20, 30, 40, 70, 100]$ and $|\eta| \in [ 0, 0.6, 1.4, 2.4]$. The electron Tag-and-Probe tools uses a centrally curated CMSSW PhysicsTools in \url{CMSSW_10_2_X}. The software pipeline consists of two steps, an ntuplizing stage and a fitting stage. The  Ntupilizing stage selects Tag-and-Probe pairs along with all potential variables of interest and loads them onto an ntuple using \url{TnPTreeProducer} \cite{ElTnPGit}. The samples used in the Ntuplizing stage are listed in Table \ref{tab:electronTnPSamples}. In the fitting stage, a random subset of of TnP pairs are sampled with \url{TnPTreeAnalyzer} \cite{ElTnPAnaGit}. The analyzer performs all of the fitting and efficiency measurements according to the specified selection criteria. 

%notes to add back in later 2016B, 2017C, 2018A
\begin{table}
\caption{ Data and MC samples for each year used by the electron Tag-and-Probe. }
\label{tab:electronTnPSamples}
\scriptsize
\begin{adjustwidth}{-0.5in}{-1in}
\begin{tabular}{cc|c}
\hline
Type & Year & Sample Name \\ 
\hline
\hline 
Data & 2016 & \tiny \url{/SingleElectron/Run2016-17Jul2018_ver2-v1/MINIAOD}  \\  
Data & 2017 & \tiny \url{/SingleElectron/Run2017-31Mar2018-v1/MINIAOD} \\  
Data & 2018 & \tiny \url{/EGamma/Run2018-17Sep2018-v2/MINIAOD} \\ 
\hline 
MC & 2016 & \tiny \url{/DYJetsToLL_M-50_TuneCUETP8M1_13TeV-madgraphMLM-pythia8/RunIISummer16MiniAODv3-PUMoriond17_94X_mcRun2_asymptotic_v3_ext2-v2/MINIAODSIM} \\ 
MC & 2017 & \tiny \url{/DYJetsToLL_M-50_TuneCP5_13TeV-madgraphMLM-pythia8/RunIIFall17MiniAODv2-PU2017RECOSIMstep_12Apr2018_94X_mc2017_realistic_v14_ext1-v1/MINIAODSIM} \\ 
MC & 2018 & \tiny \url{/DYJetsToLL_M-50_TuneCP5_13TeV-madgraphMLM-pythia8/RunIIAutumn18MiniAOD-102X_upgrade2018_realistic_v15-v1/MINIAODSIM} \\
\hline
\end{tabular} 
\end{adjustwidth}
\end{table}




A general selection is applied for electron TnP candidates that differs between the tag and probe, but, both depend on super cluster (SC) kinematics. The super clusters are expected to fall within the calorimeter acceptance which includes vetoing super clusters in the end-cap gaps. The invariant mass of the electron of the pair also is required to fall within a specified Z-window. The selection specifics are listed in Table \ref{tab:eleTnPSelect}.  The tag is also required to pass a trigger requirement to reflect the inherit trigger bias which is not applied in simulation by default. The triggers selected are HLT electron collections and are grouped by specific paths and filters. The tag electrons are matched to trigger objects in the path/filter combination and passed based on the OR of triggers in the collection. The chosen trigger combinations are \url{HLT_Ele27_eta2p1_WPTight_Gsf_v*}, \url{HLT_Ele32_WPTight_Gsf_L1DoubleEG_v*}, \url{HLT_Ele32_WPTight_Gsf_v*} for 2016 through 2018 respectively.\\

\begin{table}
\caption{Kinematic requirements for the electron Tag-and-Probe components.}
\label{tab:eleTnPSelect}
\begin{adjustwidth}{-0.45in}{-1in}
\begin{tabular}{|c|c|c|c|}
\hline 
\multicolumn{4}{|c|}{Tag-and-Probe Electron Candidate Selection Criteria} \\ 
\hline 
Tag & Probe & Super Cluster & Pair \\ 
\hline 
$|\eta_{SC}| \leq 2.1$ & $|\eta_{SC}| \leq 2.5$  & $|\eta|<2.5 $ & $50 \text{GeV} < m_{ee} < 130 \text{GeV} $ \\
veto $ 1.4442 \leq |\eta_{SC}| \leq 1.566 $ & $E_{ECAL}\sin(\theta_{SC}) > 5.0 $ GeV & $E_T > 5.0 $ GeV &  \\
 $\pt \geq 30.0$ GeV &  &  &  \\
 Passes Tight Id &  &  & \\
\hline 
\end{tabular} 
\end{adjustwidth}
\end{table}



%\begin{center}
%\begin{tabular}{@{}l@{}} 
%\tabitem 2016: \url{HLT_Ele27_eta2p1_WPTight_Gsf_v*} \\
%\tabitem 2017: \url{HLT_Ele32_WPTight_Gsf_L1DoubleEG_v*}\\
%\tabitem 2018: \url{HLT_Ele32_WPTight_Gsf_v*} \\
%\end{tabular} 
%\end{center}


%\end{center}
The measurements of the Gold, Silver, and Bronze efficiencies components, and VeryLoose, are shown in Figure \ref{fig:el2deff}. The relative efficiencies per component range from approximately $75\%$ to $95\%$ with a slight dependence on $|\eta|$. The largest combined systematic and statistical errors are $O(4\%)$ and occur in data with the lowest \pt bins. The data and MC agreement is within a few percent for both the Id, Isolation, and SIP3D. The efficiency components combined into Gold, Silver, and Bronze is shown in Figure \ref{fig:elgsb}. The range of efficiencies for each quality ranking are $(50-70)\%$, $(10-20)\%$, and $(10-30)\%$ for Gold, Silver, and Bronze respectively. The Gold, Silver, and Bronze data to MC ranges around a few percent, but large discrepancies can be seen at the highest and lowest \pt bins. More granular Id measurements could be obtained by using a different resonance such as $J/\psi \rightarrow ee$ for the lower \pt ranges, however, data triggers with electrons for $J/\psi$ are not available.

\FigFour{Lep_Obj_plots/h_2017_0_redo4-16-23_eleff.pdf}{Lep_Obj_plots/h_2017_1_redo4-16-23_eleff.pdf}{Lep_Obj_plots/h_2017_2_redo4-16-23_eleff.pdf}{Lep_Obj_plots/h_2017_3_redo4-16-23_eleff.pdf}{The 2017 individually measured electron efficiencies for Very Loose, ID, Isolation, and Impact parameter in bins of $p_T$ and $|\eta|$.}{fig:el2deff}


\FigThreeScale{Lep_Obj_plots/h_ElectronRedo_4-16-23_2017_1.pdf}{Lep_Obj_plots/h_ElectronRedo_4-16-23_2017_2.pdf}{Lep_Obj_plots/h_ElectronRedo_4-16-23_2017_3.pdf}{The 2017 combined electron efficiencies for Gold, Silver, and Bronze. }{fig:elgsb}{0.49}{0.49}{0.49}

\FloatBarrier
\section{The Muon Tag-and-Probe}
The muon Tag-and-Probe tools also uses the same centrally curated CMSSW PhysicsTools in \url{CMSSW_10_6_X}. The software pipeline is identical to electrons in that it consists of an ntuplizing \cite{MuTnPTwiki} and fitting \cite{MuTnPAnaTwiki} stage. The code bases for muons and electrons are separate but functionally identical. The samples chosen for Z measurements are shown in Table \ref{tab:mutnpsamples}. The $J/\psi$ ntuples are available from a central repository of standard Tag-and-Probe selection variables which use the pre-ultra legacy samples for each year \cite{MuTnPCentralSamps} and are used for low $p_T$ Id efficiency measurement. The muon Tag-and-Probe efficiencies are measured above 20 GeV using the Z boson and below 20 GeV with the $J/\psi$ meson. The $\eta$ bins are divided into a central and forward regions around the end-caps at $|\eta| = 2.1$. In total there are three sets of binnings: The low \pt $J/\psi$ binning $J/\psi^{L}$ for muon Id below 20 GeV, the high \pt Z binning $Z^{H}$ above 20 GeV, and the low \pt Z binning $Z^{L}$ used to extrapolate isolation and impact parameter efficiencies down to 3 GeV.  The explicit bin edges for each range are defined in Table \ref{tab:mubin}.


%notes to add in later 2016C, 2017C, 2018A
\begin{table}
\caption{Data and MC samples for each year used by the electron Tag-and-Probe.}
\label{tab:mutnpsamples}
\scriptsize
\begin{adjustwidth}{-0.5in}{-1in}
\begin{tabular}{cc|c}
\hline 
Type & Year & Sample Name \\ 
\hline 
\hline
Data & 2016 & \tiny \url{/SingleMuon/Run2016-17Jul2018-v1/MINIAOD}  \\  
Data & 2017 & \tiny \url{/SingleMuon/Run2017-31Mar2018-v1/MINIAOD} \\  
Data & 2018 & \tiny \url{/SingleMuon/Run2018-17Sep2018-v2/MINIAOD} \\ 
\hline 
MC & 2016 & \tiny \url{/DYJetsToLL_M-50_TuneCUETP8M1_13TeV-madgraphMLM-pythia8/RunIISummer16MiniAODv3-PUMoriond17_94X_mcRun2_asymptotic_v3_ext2-v2/MINIAODSIM} \\ 
MC & 2017 & \tiny \url{/DYJetsToLL_M-50_TuneCP5_13TeV-madgraphMLM-pythia8/RunIIFall17MiniAODv2-PU2017RECOSIMstep_12Apr2018_94X_mc2017_realistic_v14_ext1-v1/MINIAODSIM} \\ 
MC & 2018 & \tiny \url{/DYJetsToLL_M-50_TuneCP5_13TeV-madgraphMLM-pythia8/RunIIAutumn18MiniAOD-102X_upgrade2018_realistic_v15-v1/MINIAODSIM} \\ 
\hline
\end{tabular} 
\end{adjustwidth}
\end{table}

\begin{table}
\caption{Names of centrally produced $J/\psi$ Tag-and-Probe trees.}
\label{tab:jpsimutnpsamples}
\scriptsize
\centering
\begin{tabular}{cc|c}
\hline 
Type & Year & Sample Name \\ 
\hline 
\hline
Data & 2016 & \tiny \url{TnPTreeJPsi_LegacyRereco07Aug17_Charmonium_Run2016Bver2_GoldenJSON.root}  \\  
Data & 2017 & \tiny \url{TnPTreeJPsi_17Nov2017_Charmonium_Run2017Cv1_Full_GoldenJSON.root} \\  
Data & 2018 & \tiny \url{TnPTreeJPsi_Charmonium_Run2018Dv2_GoldenJSON.root} \\ 
\hline 
MC & 2016 & \tiny \url{TnPTreeJPsi_80X_JpsiToMuMu_JpsiPt8_Pythia8.root} \\ 
MC & 2017 & \tiny \url{TnPTreeJPsi_94X_JpsiToMuMu_Pythia8.root} \\ 
MC & 2018 & \tiny \url{TnPTreeJPsi_102XAutumn18_JpsiToMuMu_JpsiPt8_Pythia8.root} \\ 
\hline
\end{tabular} 
\end{table}

\begin{table}
\centering
\caption{Muon bin edges for the $J/\psi$ case, high $p_T$ Z case, and low $p_T$ fitting case $Z^{L}$. }
\label{tab:mubin}
\begin{tabular}{c|c|c}
\hline 
\multicolumn{3}{c}{Muon Binning} \\ 
\hline 
Range & $p_T$ GeV & $|\eta|$ \\ 
\hline 
$J/\psi^{L}$ & [3.0, 4.0,  5.0, 6.0, 7.0, 9.0, 14.0,  20.0] & [0, 1.2, 2.4] \\ 

$Z^{H}$ &  [10, 20, 30, 40, 60, 100] & [0, 1.2, 2.4] \\ 

$Z^{L}$ & [6,8,10,14,18,22,28,32,38,44,50] & [0, 1.2, 2.4] \\ 
\hline 
\end{tabular} 
\end{table}

%\begin{itemize}
%\item $J/\psi^{L}$  
%	\begin{itemize}
%		\item[] $p_T \in [3.0, 4.0,  5.0, 6.0, 7.0, 9.0, 14.0,  20.0]$
%		\item[]  $\eta| \in [0, 1.2, 2.4]$
%	\end{itemize}
%\item $Z^{H}$
%	\begin{itemize}
%		\item[] $ p_T \in [10, 20, 30, 40, 60, 100]$
%		\item[] $|\eta| \in [ 0, 1.2, 2.4]$
%	\end{itemize}
%\item $Z^{L}$
%	\begin{itemize}
%		\item[] $ p_T \in [6,8,10,14,18,22,28,32,38,44,50]$ 
%		\item[] $|\eta| \in [0, 1.2, 2.4]$
%	\end{itemize}
%\end{itemize}


Isolation and impact parameters are unable to be measured using the $J/\psi$. About $30\%$ of prompt $J/\psi$ are produced from $\chi_c$ and $\Psi(2S)$ inside a jet and likely will be unisolated \cite{Lansberg:2006dh}. Similarly another $10\%$ of all $J/\psi$ are produced within b-jets and leading to  non-prompt  unisolated events \cite{LHCb:2013itw}.

The criteria for the tag or probe vary between $Z$ and $J/\psi$ but are identical across the two $Z$ ranges. The selections follow the standard criteria defined from the centrally produced muon Tag-and-Probe efficiencies and are described in Table \ref{tab:mutnpselect}.\\

\begin{table}
\small
\caption{Kinematic requirements for the muon Tag-and-Probe components.}
\centering
\begin{tabular}{|c|c|c|}
\hline 
\multicolumn{3}{|c|}{Tag-and-Probe Muon Candidate Selection Criteria} \\ 
\hline 
%\multicolumn{3}{|c|}{$J/\psi$} \\
\hline
Tag & Probe & Pair \\ 
\hline 
%isGlobalMuon & Matches hltTracksIter   & $2.8 \text{GeV} < m_{\mu\mu} < 3.4 \text{GeV} $ \\
%numberOfMatchedStations$>1$  & OR &  $|z_{\mu_1} - z_{\mu_2}| <1 $ cm\\
% $\pt > 5$ GeV & Matches hltMuTrackJpsiEffCtfTrackCands &    \\
% Matches hltIterL3MuonCandidates &   & \\
%\hline
\hline
passes tightID & No requirement & $m_{\mu\mu} > 60$ GeV \\
$\sum \pt^{ch} / \pt < 0.2$ & &  $|z_{\mu_1} - z_{\mu_2}| <4 $ cm \\
$\pt > 15$ GeV &   &   \\
\hline 
\end{tabular} 
\label{tab:mutpnselect}
\end{table}

The muon data will also has an implicit selection due to triggering. To reflect the trigger bias in MC, the tag is required to pass a chosen trigger in the efficiency denominator in addition to HLT object matching. The triggers available vary from year to year for $Z$ using \url{IsoTkMu22} in 2016 and \url{isoMu24eta2p1} in 2017 and 2018. $J/\psi$ uses the same trigger for all years, which is \url{Mu7p5Tk2}.\\

%\begin{center}
%\begin{tabular}{@{}l@{}} 
%\tabitem $J/\psi$ 2016,2017,2018: \url{Mu7p5Tk2} \\
%\tabitem $Z$ 2016: \url{IsoTkMu22}\\
%\tabitem $Z$ 2017, 2018: \url{isoMu24eta2p1} \\
%%\end{tabular} 
%\end{center}





 The Gold, Silver, and Bronze efficiency definitions used the same bin ranges $J/\psi^L$, $Z^L$, and $Z^H$ shown in Table \ref{tab:mubin}. The explicit form for Gold Silver and Bronze based on $p_T$ range and as a function of conditional efficiency components of ID, Isolation, and SIP3D are shown in table \ref{tab:gsbeqs}. The low \pt muons include the Id measured by $J/\psi$ as well as the extrapolated efficiencies from SIP3D and isolation fits in $Z_{L}$. The high \pt muons are composed of all the factors directly measured in $Z_H$.
\begin{table}
\caption{The formulation of Gold, Silver, and Bronze efficiencies as a function of conditional Tag-and-Probe efficiency components.} 
\label{tab:gsbeqs}
\begin{itemize}
\item[] $\pt \in [3,20)$
\end{itemize}
\begin{equation}\label{eq:effcomp_J}
\begin{split}
\epsilon_{\Gold}& = \epsilon_{\ID}^{J/\psi}\times \epsilon_{\Isolated|\ID}^{Z_L} \times \epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_L} \\
\epsilon_{\Silver}& = \epsilon_{\ID}^{J/\psi} \times \epsilon_{\Isolated|\ID}^{Z_L} \times (1-\epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_L}) \\
\epsilon_{\Bronze}& = 1-(\epsilon_{\ID}^{J/\psi} \times \epsilon_{\Isolated|\ID}^{Z_L})
\end{split}
\end{equation}
%\quad \quad \\
\begin{itemize}
\item[] $\pt \in [20,100 ]$
\end{itemize}
\begin{equation}\label{eq:effcomp_Z}
\begin{split}
\epsilon_{\Gold}& = \epsilon_{\ID}^{Z_H}\times\epsilon_{\Isolated|\ID}^{Z_H}\times\epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_H} \\
\epsilon_{\Silver}& = \epsilon_{\ID}^{Z_H}\times\epsilon_{\Isolated|\ID}^{Z_H}\times(1-\epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_H})\\
\epsilon_{\Bronze}& = 1-(\epsilon_{\ID}^{Z_H} \times \epsilon_{\Isolated|\ID}^{Z_H})
\end{split}
\end{equation}

\end{table}

 The 2017 efficiencies for Id, Isolation, SIP3D, and VeryLoose are shown in Figure \ref{fig:jpsiZ17-ideff-ratio}. The efficiencies for the other years are nearly identical. The overlapping bins of efficiency between $J/\psi$ and $Z$ do not all match within statistical uncertainties. However, the average deviation of the efficiency central values are $0.02\%$ for MC and $1\%$ for data.  The relative efficiencies per component range from approximately $88\%$ to $98\%$ and are fairly uniform between the barrel and end-caps. The efficiencies for the isolation ranges from $(90 - 95)\%$ where the end-caps generally are about $5\%$ more efficient. As for SIP3D, the efficiency ranges from about $(80 - 93)\%$ with another $5\%$ $|\eta|$ based efficiency gap, however, in the SIP3D case, the barrel is more efficient as opposed to isolation.  The extrapolation of the vertexing and isolation efficiencies below 20 GeV is done by fitting a quadratic polynomial to the efficiencies on the $Z_L$ interval.  Both data and MC are shown in Figure \ref{fig:eff17-extraps}.  The errors for each bin are the combined statistical and systematic errors from Table \ref{tab:musyst} and are adjusted before the polynomial fit. Any efficiencies below 20 GeV are then reported from the fit model. The fit errors are the 68\% confidence interval combined with the systematic errors. The worst observed right tail P-value from all fits is $\approx 2\%$, the median P-value from the Figure \ref{fig:eff17-extraps} is $84\%$. The fits in each year behave qualitatively the same as 2017.
The product of the efficiency components into their corresponding Gold, Silver, and Bronze category is shown in Figure \ref{fig:2017-mu1-gsbvl}. The range of efficiencies for each quality ranking are $(70 - 80)\%$, $(5 - 15)\%$, and $(4 - 20)\%$ for Gold, Silver, and Bronze respectively. The Data and MC agreement for all three ranks is better than electrons with the largest discrepancy in Gold being $2\%$ and the average deviation in Silver and Bronze begin approximately $(5-10)\%$.

%The very loose and the efficiency components combined into Gold, Silver, and Bronze are summarized in Figure \ref{fig:2017-mu1-gsbvl}, the other years are included in %the appendix. The tool used to store/calculate efficiencies can be found at \url{https://github.com/Jphsx/LepTool}.  The cumulative efficiency for a muon also includes %the efficiency of the VeryLoose selection and is defined as:
%\begin{equation}
%\epsilon_\mu = \epsilon_{\text{VeryLoose}} \times \epsilon_{\text{Gold/Silver/Bronze}}
%\end{equation}



\FigFour{Lep_Obj_plots/h_2017_0_mueff.pdf}{Lep_Obj_plots/h_2017_1_mueff.pdf}{Lep_Obj_plots/h_2017_2_mueff.pdf}{Lep_Obj_plots/h_2017_3_mueff.pdf}{Tag-and-Probe efficiencies for the muon Very Loose, Id, Isolation, and SIP3D in 2017. Uses the efficiency shape fit from Figure \ref{fig:eff17-extraps} to extrapolate isolation and SIP3D to low $p_T$. Also includes the $J/\psi$ contribution below 20 GeV. Low $p_T$ binning does not reflect actual bin granularity, bins are merged for readability. }{fig:jpsiZ17-ideff-ratio}

\FigureTwo{effFit_2.pdf}{effFit_5.pdf}%
          {fig:eff17-extraps}{The fitted muon isolation and SIP3D efficiencies for 2017. Includes both data and MC which are separated between barrel and end-cap.  }



\FigureThree{h_2017_1_mu.pdf}{h_2017_2_mu.pdf}{h_2017_3_mu.pdf}{The combined efficiency components from equations \ref{eq:effcomp_J} and \ref{eq:effcomp_Z} and Very Loose for 2017. The low-\pt region ($<20$ GeV) includes the contributions from $J/\psi$ as well as the isolation and SIP3D extrapolations. Propagated errors are treated as uncorrelated.}{fig:2017-mu1-gsbvl}

\FloatBarrier
\section{Lepton Systematics and Scale Factors}

The systematic error for the electron and muon efficiencies are derived by varying the Tag-and-Probe signal and background models, shifting the mass window , increasing and decreasing the number of bins used in the fit, varying the selection on the tag, and testing MC samples with different generators. The systematic error is defined as the maximum spread in efficiencies between the efficiency variations with an example spread shown in Figure \ref{fig:systspread}.  Rather than compute the systematic error for every bin, similarities between neighboring bins motivates using a simplified bin approach which was chosen qualitatively by the background shape. The shape of the \pt based mass distributions is illustrated in Figure \ref{fig:systplots}. The same $\eta$ bins are utilized according to lepton flavor, but the \pt bins are consolidated into a high and low bin pivoting on $20$ GeV. A high and low systematic is derived for each selection criteria per flavor per year and is applied to the efficiencies that fall within the corresponding \pt and $\eta$ range for modeling shape systematics. The tag systematics are computed by varying the $p_T$ requirement on the tag and are found to be $<1\%$. The MC systematics are computed by comparing ZDY MC sample with Z $p_T$ ranging between 100-250 GeV against an inclusive sample and is found to be about $1\%$. 
%todo syst spread fig
%todo syst tnp dist
\FigureStack{muons_lowpt_syst.png}{muons_highpt_syst.png}%
	{fig:systplots}{Tag-and-Probe di-muon mass distributions for both passing and failing probes. The top set of plots consist of probes below 20 GeV and the bottom set are about 20 GeV.}
	


Scale factors are derived bin by bin for each criteria per flavor per year by finding the ratio of efficiencies in data to Monte Carlo. The scale factor error is propagated by combining both the statistical error from the Tag-and-Probe in quadrature with the systematic error. The full 2017 set of shape modeling systematics for electrons and muons is shown in Table \ref{tab:elesysts} and Table \ref{tab:musysttable} and are nearly identical to the systematics derived in the other years. Additional scale factors are also needed to adjust the differences between samples which are either created with a full simulation or fast simulation. The fast to full factor is obtained by extracting the efficiency ratio between  full and fast sim $t\bar{t}$ MC.

\FigureOne{2017data_medID_msyst.pdf}{Example systematic spread from various fit models and binnings for muons. Includes the four combinations of regions either low or high $p_T$ and central and forward $|\eta|$.}{fig:systspread}
	
\begin{table}
\centering
\caption{The electron modeling systematic error derived from the Tag-and-Probe for 2017 data and split into $p_T$ and $|\eta|$ regions. }
\label{tab:elesysts}
\begin{tabular}{|c|ccc|}
\hline
ID & $0\leq |\eta|<0.8$ & $0.8\leq |\eta|<1.479$ & $|\eta|\geq1.479$ \\
\hline
$\pt < 20$ [GeV] & 0.003 & 0.001 & 0.005 \\
$\pt \geq 20$ [GeV] & 0.001 & 0.001 & 0.002  \\
 &  &  &    \\
\hline
Iso $|$ ID  &  &  &   \\
\hline
$\pt < 20$ [GeV] & 0.002 & 0.003 & 0.003   \\
$\pt \geq 20$ [GeV] & 0.001 & 0.001 & 0.002 \\
 &  &  &   \\
\hline
SIP $|$ Iso $\cap$ ID &  &  &  \\
\hline
$\pt < 20$ [GeV]& 0.006 & 0.004 & 0.007 \\
$\pt \geq 20$ [GeV]& 0.002 & 0.002 & 0.0006  \\
\hline
VeryLoose &  &  &  \\
\hline
$\pt < 20$ [GeV]& 0.002 & 0.007 & 0.03 \\
$\pt \geq 20$ [GeV]& 0.003 & 0.0001 & 0.0007 \\
\hline
\end{tabular}
\end{table}


\begin{table}[htbp]
\centering
\caption{The muon modeling systematic error derived from the Tag-and-Probe data and split into \pt and $|\eta|$ regions. }
\label{tab:musysttable}
\begin{tabular}{|c|cc|}
\hline
ID & $|\eta|<1.2$ & $|\eta|\geq 1.2$  \\
\hline
$\pt < 20$ [GeV](J) & 0.001 & 0.001  \\

$\pt \geq 20$ [GeV](Z) &  0.001& 0.0003 \\

 &  & \\
\hline
Iso $|$ ID  &  &  \\
\hline
$\pt < 20$ [GeV]  & 0.007 & 0.004  \\

$\pt \geq 20$ [GeV] & 0.007 & 0.002  \\

 &  &  \\
\hline
SIP $|$ Iso $\cap$ ID &  &  \\
\hline
$\pt < 20$ [GeV]& 0.005 & 0.003 \\

$\pt \geq 20$ [GeV]& 0.001 & 0.002 \\
 & &  \\
\hline
Very Loose & &  \\
\hline
$\pt < 20 $ [GeV]  & 0.001 & 0.0003 \\
$\pt \geq 20$ [GeV]  & 0.001 & 0.001 \\
\hline
\end{tabular}
\label{tab:musyst}
\end{table}


