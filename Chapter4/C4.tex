\newcommand{\ID}{\text{ID}}
\newcommand{\Prompt}{\text{Prompt}}
\newcommand{\Isolated}{\text{Isolated}}
\newcommand{\Gold}{\text{Gold}}
\newcommand{\Silver}{\text{Silver}}
\newcommand{\Bronze}{\text{Bronze}}



\newcommand\FigureFour[6]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#1}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#2}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#3}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#4}\hfill
\caption{#6}
\label{#5}
\end{figure}}

\newcommand\FigureThree[5]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.4\textwidth]{fig/Lep_Obj_plots/#1}
\includegraphics[width=0.4\textwidth]{fig/Lep_Obj_plots/#2}\hfill
\includegraphics[width=0.4\textwidth]{fig/Lep_Obj_plots/#3}\hfill
\caption{#4}
\label{#5}
\end{figure}}

\newcommand\FigureTwo[4]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#1}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#2}\hfill
\caption{#4}
\label{#3}
\end{figure}}

\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}
\setlength{\parskip}{\smallskipamount}
\setlength{\parindent}{0pt}


\makeatletter


\providecommand{\tabularnewline}{\\}


\makeatother

%\usepackage{babel}
%\begin{document}

\chapter{The Tag-and-Probe}

\begin{chapterabstract}
The tag-and-probe is a method used to measure the selection efficiencies of an object using data. In the context of this compressed SUSY analysis, the Tag-and-probe measures the efficiencies separately of each light lepton selection critera. The total lepton selection efficiency is then computed by combining factorized efficiency components. The same general method is used for both electrons and muons, however, Muons utilize  the $J/\psi$ di-muon trigger which allow more precise efficiency measurements from data at lower $p_T$.
\end{chapterabstract}

\section{Introduction and Methodology}
An important element of a lepton based search is properly modeling the efficiency of selected leptons. A purely Monte-Carlo driven approach is inadequate in perfectly describing nuances in data due to imperfections in modeling. Instead of trying to model exactly all physics and detector effects with simulation, the efficiencies can be directly measured from data by using the Tag-and-Probe method. 

The Tag-and-Probe method is used to measure a selection criteria by using a well known resonance such as a $Z$, $J/\psi$, or $\Upsilon$ and counting the number of probes that pass that criteria. Each counted instance of the Tag-and-Probe consists of two selected leptons. One of the selected leptons is the tag and the other is the probe.  The tag passes tight selection requirement to give high confidence that it isn't a fake lepton. Fake leptons fall into two possible categories: reducible and irreducible. A reducible fake lepton is a particle that fakes the signature of a lepton such as a charged pion. An irreducible fake lepton is an actual lepton which coincidentally passes some selection criteria but is not the targeted leptons of interest e.g. an isolated muon from a jet accompanying a leptonic Z decay of interest.  The  second lepton in the Tag-and-Probe is the probe. The probe is subjected to the selection criteria whose efficiency is being measured. The invariant mass of pair of leptons is calculated and required to fall within a defined range around the resonance. A particular event may have multiple lepton pairs but the tag and the probe are not allowed to switch positions and be counted twice, as double counting would lead to a bias in the efficiency measurement \cite(AN111-2009). To avoid bias, the tag and probe are required to be the opposite charge and same flavor where the tag being randomly selected. If multiple lepton pairs occur in single event, no specific arbitration is used in selecting a single pair, all pairs are used and the pair that is not truly from the resonance will then contribute as combinitorial background. The selected probes can either pass or fail their selection which leads to the formation of three distributions, one with a passing probe, one with a failing probe, and one with all probes. An example of all three distributions is shown in Figure X. The probability of observing $k$ passing probes in $n$ Tag-and-Probe pair trials is dependent on the selection efficiency $\varepsilon$ and can be expressed as a binomial likelihood $P(k|\varepsilon,n) = \binom{n}{k}\varepsilon^k(1-\varepsilon)^{n-k}$. The MLE estimator for efficiency is then the fraction of passing probes from the total number of pairs, or $\varepsilon = k/n$. Technical documentation for the Tag-and-Probe in CMS is scarce, but, an early strategy for fitting efficiency is defined in \cite{Berryhill_2010}. The legacy code base as of \url{CMSSW_10_6_X}  uses a binned maximum likelihood between the observed passing probes and failing probes where the efficiency extracted is an explicit fit parameter. The two simultaneously fit functions are:
\begin{equation}
	N^{\text{Pass}} = N_{\text{Total}} (\varepsilon \cdot f^{\text{sig}}_{\text{All}} ) +  \varepsilon_{\text{bkg}} \cdot (1-f^{\text{sig} }_{\text{All}}) )
\end{equation} 
\begin{equation}
	N^{\text{Fail}} = N_{\text{Total}} ( (1-\varepsilon) \cdot f^{\text{sig}}_{\text{All}} +   (1-\varepsilon_{\text{bkg}}) \cdot (1-f^{\text{sig}}_{\text{All}}) )
\end{equation}

$N^{\text{Pass/Fail}}$ is the total number of observed probes that either pass or fail the selection criteria while $N_{\text{Total}}$ is the total number of Tag-and-Probe pairs.
The binomial estimator for efficiency, $\varepsilon$, enters the fit functions as the first term but is accompanied by a second term that describes the background contribution with its own efficiency $\varepsilon_{\text{bkg}}$.  The term $f^{\text{sig}}_{\text{All}}$ is the fraction of background subtracted signal events over the allowed dilepton mass range.  $f^{\text{sig}}_{\text{All}}$ depends on the defined signal and background pdfs. The nominal pdfs chosen for reported fits uses a Voigtian+Voigtian signal model combined with an Exponential background model. 


\FigureThree{PassingProbes_Med16_lowpt.png}{FailingProbes_Med16_lowpt.png}{AllProbes_Med16_lowpt.png}{Example Tag-and-Probe Z di-muon fits for passing,failing, and all probes with the Medium Id, $|\eta|<1.2$, and $p_T < 20$ GeV   }{tnpexp}



%The distributions are fit simultaneously with a combined signal and background model. To extract the probe criteria efficiecy we divide the resonance distributions by the all probes distribution. The uncertainty on an efficiency is a combination of a statistical and systematic uncertainties. The systematic uncertainties are defined by repeating the simultaneous fit with varying mass windows, number of bins, and fit models and measuring the maximum spread of the central values.


%The fit code is located here: \url{https://github.com/cms-sw/cmssw/blob/CMSSW_10_6_X/PhysicsTools/TagAndProbe/src/TagProbeFitter.cc} around line 600. confirm this with the fit model from the electron paper. \cite{Berryhill_2010}

\FloatBarrier
\section{Lepton Object Definitions}


Leptons are selected according to the minimium requirment ``VeryLoose'' and is defined in Table \ref{tab:veryloose}.  The set of VeryLoose leptons are further subdivided by quality into three mutually exclusive categories: Gold, Silver, and Bronze. Each category has a measure of three main quantities: the quality of the pre-determined ID (citation about ID here), the "promptness" or distance of the lepton production point from the primary vertex, and the isolation. Promptness is measured by the significance of the 3D impact parameter whereas the isolation is a measure of the density of particles in a cone around the lepton. Two similar but complimentary absolute isolations are used: PFIso and MiniIso. Both isolations are an energy sum of neighboring particles inside a cone, but, PFIso has a fixed cone size of $R=0.4$ cm  and miniIso cone sizes varies inversely with lepton \pt as shown in \ref{isoeq}.
\begin{equation}
\label{isoeq}
R_{\text{miniIso}}=
    \begin{cases}
      0.2 & \pt^\ell < 50 \text{GeV}\\
      \frac{10}{\pt^\ell} & 50 \text{GeV} \leq \pt^\ell \leq 200 \text{GeV} \\
      0.05 & \pt^\ell > 200 \text{GeV}
    \end{cases}
\end{equation}

Mini isolation also includes effective area pile-up corrections provided in a look up table of bins of \pt and $\eta$ in the CMSSW Producer/Ntuplizing stage. The implementation of mini-isolation and their corrections utilize the same IsoValueMap producer as used in NANO AOD as of \url{CMSSW_10_6_X}.


The explicit formulas for both electrons and muons can be generalized with the three factorized components previously mentioned:
\begin{equation}\label{eq:efflep_general}
\begin{split}
\epsilon_{\Gold}& = \epsilon_{\ID}\times \epsilon_{\Isolated|\ID} \times \epsilon_{\Prompt|(\ID \cap \Isolated)} \\
\epsilon_{\Silver}& = \epsilon_{\ID} \times \epsilon_{\Isolated|\ID} \times (1-\epsilon_{\Prompt|(\ID \cap \Isolated)}) \\
\epsilon_{\Bronze}& = 1-(\epsilon_{\ID} \times \epsilon_{\Isolated|\ID)} )
\end{split}
\end{equation}

The isolation and vertexing requirements are physically uncorrelated, but there exists intersection between the criteria e.g. a lepton can be prompt and isolated. This intersection then demands the necessity for conditional efficiencies.  The order of the conditional efficiencies is also chosen to minimize the number of measured efficiencies by reusing efficiencies across Gold, Silver, and Bronze.  





\begin{table}[htbp]
\centering
\caption{\label{tab:veryloose} The criteria define the minimum requirements for a lepton accepted. The electron and muon requirements are equivalent in terms of pseudorapidity, vertexing, and isolation but vary in \pt threshold and the MVA VLooseFO working point. The MVA VLooseFO ID also varies between years.}

\begin{tabular}{c|c|c}
\hline
Criteria & Electron & Muon \\
\hline
\hline
\pt & $\geq 5$ GeV & $\geq 3$ GeV \\

$|\eta|$ & $<2.4$ & $<2.4$ \\
\hline

$\text{IP}_{3D}/\sigma_{\text{IP}_{3D}}$ & $<8$ & $<8$ \\

$|d_{xy}|$ & $<0.05$ cm & $<0.05$ cm \\

$|d_z|$ & $<0.1$ cm & $<0.1$ cm \\

\hline
$\text{PFIso}_{\text{abs}}$ & $<20 + (300/\pt)$ GeV & $<20 + (300/\pt)$ GeV \\

\hline
MVA VLooseFO ID & \checkmark  & --\\
\end{tabular}
\end{table}


The purpose of the various lepton quality categories is to boost the overall stats, this can help us sample various areas things to boost the efficiency for general signals. but also provide fake rich selection in control region that helps stabilize the overall fit and extract fake rates into the sensitive regions.  The differentn truth selected objects by lepton quality is shown in Figure \ref{andresPurity}. The gold region is a pure mainly populated by prompt leptons that are produced directly near the primary vertex, the prompt production of leptons also coincides to most of the targed electroweakino models. The silver selection accomodates both leptonically decaying taus and some isolated semileptonic b decays, this selection assists in recovering efficiency for stop production involving b decays as well as being the ideal region for stau production.  The bronze selection is rich and fakes and provides the best sample to extract overall fake rates to extrapolate into other regions. 



\FigureThree{gold_ele_TTJets_Fall17.pdf}{silver_ele_TTJets_Fall17.pdf}{bronze_ele_TTJets_Fall17.pdf}{Gold, Silver and Bronzed MC truth matching in TTJets sample 2017. Signal is defined here as electrons following W decay.}{andresPurity}

\FloatBarrier
\section{Electron Tag-and-Probe }

The electron tag and probe is done by using the Z resonance is used over the entire \pt range of selected electrons. 

What are the binnings
$Z$
	\begin{itemize}
		\item[] $ p_T \in [5, 10, 20, 30, 40, 70, 100]$
		\item[] $|\eta| \in [ 0, 0.6, 1.4, 2.4]$
	\end{itemize}


what are the tag/probe/pair requirements
tag: passes tight id \\ 
also tag: $(abs(-log(tan(superCluster.position.theta/2)))<=2.1) and !(1.4442<=abs(-log(tan(superClusterPosition.theta/2)))<=1.566) and pt >= 30.0$ \\
probe: $ecalEnergy*sin(superClusterPosition.theta)>5.0 and  (abs(-log(tan(superClusterPosition.theta/2)))<2.5)$
supercluster: $abs(eta)<2.5 and  et>5.0$ \\
pair: $50 \, GeV<m_{ee}<130 GeV$ \\

The triggers selected are collections of HLT for electrons and are grouped by specific paths and filters. The tag electrons are matched to trigger objects in the path/filter combination and passed based on the OR of triggers in the collection. The probes are not subjected to trigger matching.\\

What are the triggers paths\\ 
2016 \url{HLT_Ele27_eta2p1_WPTight_Gsf_v*}\\
2017 \url{HLT_Ele32_WPTight_Gsf_L1DoubleEG_v*}\\
2018 \url{HLT_Ele32_WPTight_Gsf_v*}\\

How to calculate gold silver and bronze
The gold silver and bronze efficiencies are calculated  based one the same prescprtion defined in Equations \ref{eq:efflep_general}

efficiency plots, I'll have to actually make these myself....

\section{Muon Tag-and-Probe}

For the muon tag and probe we measure efficiencies above 20 GeV using the Z and below 20 GeV using J/$\psi$ there are central and forward $\eta$ bins which are divided at the endcaps at $\eta = 2.1$ The bins edges follow the recommendation from the muon object group and are as follows:\\
CITE JPSI production in bjets

There are three sets of binnings: The low pt jpsi binning $J/\psi^{Low}$ used to measure muon id below 20 GeV, the high pt Z binning $Z^{High}$ used to measure all efficiencies above 20 GeV, and the low pt Z binning $Z^{Low}$ used to extrapolate isolation and IP efficiencies down to 3 GeV.
The explicit bin edges are:
\begin{itemize}
\item $J/\psi^{Low}$  
	\begin{itemize}
		\item[] $p_T \in [3.0, 4.0,  5.0, 6.0, 7.0, 9.0, 14.0,  20.0]$
		\item[]  $\eta| \in [0, 1.2, 2.4]$
	\end{itemize}
\item $Z^{High}$
	\begin{itemize}
		\item[] $ p_T \in [10, 20, 30, 40, 60, 100]$
		\item[] $|\eta| \in [ 0, 1.2, 2.4]$
	\end{itemize}
\item $Z^{Low}$
	\begin{itemize}
		\item[] $ p_T \in [6,8,10,14,18,22,28,32,38,44,50]$ 
		\item[] $|\eta| \in [0, 1.2, 2.4]$
	\end{itemize}
\end{itemize}
The exact criteria chosen for the tag and probe also follows the recommendations from the muon group.\\
Tag:\\
$J/\Psi: isGlobalMuon, \, \, p_T>5 \text{GeV} , \, \, numberOfMatchedStations > 1, \,\, \text{Matches trigger object in hltIterL3MuonCandidates}$\\
Probe:\\
$J/\Psi: \text{Matches trigger object in hltTracksIter or hltMuTrackJpsiEffCtfTrackCands}$\\j
Pair:\\
$J: 2.8 < m_{\ell\ell} < 3.4 \, \, , | z_{\ell_1} - z_{\ell_2} | < 1 \text{cm}$


Tag:\\
$Z: p_T>15 \text{GeV}, \, \, \text{passes tightID}, \, \, (\sum p_T^{chg-hadron})/p_T < 0.2$\\
Probe:\\
$Z: No requirement$\\
Pair:\\
$Z: m_{\ell\ell} > 60 \text{GeV} \, \, , |z_{\ell_1} - z_{\ell_2}| < 4 \text{cm}$



For MC there is an inherit difference in the objects selected. Data will also have an implicit selection due to triggering. To account trigger bias and better simulate the behavior of data, trigger bits are added to the denominator of efficiency for all criteria. The triggers available vary from year to year and are as follows:\\

$2016 J Mu7p5Tk2$\\
$2017 J Mu7p5Tk2$\\
$2018 J Mu7p5Tk2$\\
$2016 Z IsoTkMu22$\\
$2017 Z isoMu24eta2p1$\\
$2018 Z isoMu24eta2p1$\\


The muon efficiencies are derived from two separate processes with the Tag-and-Probe method. For the range of muons with $3 \leq \pt < 20$ the Medium Id is measured directly from $J/\psi$. For higher momentum muons above 20 GeV, $Z$ is used to measure all the efficiency components of Equation \ref{eq:lepgsb}. The production of $J/\psi$ in  b-jets inhibits directly measuring efficiencies with vertexing or isolation, so, the vertexing and isolation efficiencies are extrapolated from Z fits to low \pt. Two different binnings and ranges are defined for the $Z$ measurements, they are denoted by $Z_H \in [20,100]$ GeV, which is used for the higher momentum direct efficiency measurements, and $Z_L \in [6,50]$ GeV , which is used for extrapolating efficiencies into the lower \pt range. The overall efficiency and scale factors for the three muon tiers are obtained by factorizing the efficiency into mutually exclusive components from the subsets defined in Equation \ref{eq:lepsubsets}. The efficiency factors depend on the range of \pt and are defined as:


\begin{itemize}
\item[] $\pt \in [3,20)$
\end{itemize}
\begin{equation}\label{eq:effcomp_J}
\begin{split}
\epsilon_{\Gold}& = \epsilon_{\ID}^{J/\psi}\times \epsilon_{\Isolated|\ID}^{Z_L} \times \epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_L} \\
\epsilon_{\Silver}& = \epsilon_{\ID}^{J/\psi} \times \epsilon_{\Isolated|\ID}^{Z_L} \times (1-\epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_L}) \\
\epsilon_{\Bronze}& = 1-(\epsilon_{\ID}^{J/\psi} \times \epsilon_{\Isolated|\ID}^{Z_L})
\end{split}
\end{equation}
%\quad \quad \\
\begin{itemize}
\item[] $\pt \in [20,100 ]$
\end{itemize}
\begin{equation}\label{eq:effcomp_Z}
\begin{split}
\epsilon_{\Gold}& = \epsilon_{\ID}^{Z_H}\times\epsilon_{\Isolated|\ID}^{Z_H}\times\epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_H} \\
\epsilon_{\Silver}& = \epsilon_{\ID}^{Z_H}\times\epsilon_{\Isolated|\ID}^{Z_H}\times(1-\epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_H})\\
\epsilon_{\Bronze}& = 1-(\epsilon_{\ID}^{Z_H} \times \epsilon_{\Isolated|\ID}^{Z_H})
\end{split}
\end{equation}

 The ID efficiency with statistical errors for both data and MC are shown in Figure \ref{fig:jpsiZ17-ideff-ratio}. The other efficiencies for each year for all \pt ranges are included in the appendix. The overlapping bins between $J/\psi$ and $Z$ do not all match within statistical uncertainties. However, the average deviation of the efficiency central values are $0.02\%$ for MC and $1\%$ for data.  



The extrapolation of the vertexing and isolation efficiencies below 20 GeV is done by fitting a quadratic polynomial to the efficiencies on the $Z_L$ interval.  Both data and MC are shown in Figure \ref{fig:eff17-extraps}.  The errors for each bin are the combined statistical and systematic errors from Table \ref{tab:musyst} and are adjusted before the polynomial fit. Any efficiencies below 20 GeV are then reported from the fit model. The fit errors are the 68\% confidence interval combined with the systematic errors. The worst observed P-value is $\approx 2\%$ but most of the fits are high quality.

The very loose and the efficiency components combined into Gold, Silver, and Bronze are summarized in Figure \ref{fig:2017-mu1-gsbvl}, the other years are included in the appendix. The tool used to store/calculate efficiencies can be found at \url{https://github.com/Jphsx/LepTool}.  The cumulative efficiency for a muon also includes the efficiency of the VeryLoose selection and is defined as:
\begin{equation}
\epsilon_\mu = \epsilon_{\text{VeryLoose}} \times \epsilon_{\text{Gold/Silver/Bronze}}
\end{equation}



\FigureFour{canvas0J2017b.pdf}{canvas1J2017e.pdf}%
           {canvas0Z2017b.pdf}{canvas1Z2017e.pdf}%
          {fig:jpsiZ17-ideff-ratio}{Tag-and-Probe efficiencies for the Medium Id in 2017. The left plots show the barrel while the right plots show the endcaps. The top fits use $J/\psi$ resonance while the bottom use the Z resonance. }

\FigureTwo{effFit_2.pdf}{effFit_5.pdf}%
          {fig:eff17-extraps}{The fitted muon isolation and SIP3D efficiencies for 2017. Includes both data and MC which are separated between barrel and endcap.  }



\FigureFour{h_2017_1.pdf}{h_2017_2.pdf}
		   {h_2017_3.pdf}{h_2017_0.pdf}
		   {fig:2017-mu1-gsbvl}{The combined efficiency components from equations \ref{eq:effcomp_J} and \ref{eq:effcomp_Z} and Very Loose for 2017. The low-\pt region ($<20$ GeV) includes the contributions from $J/\psi$ as well as the isolation and SIP3D extrapolations. Propagated errors are treated as uncorrelated.}


\section{Lepton Systematics}

The systematic error for the muon efficiencies is derived by varying the Tag-and-Probe signal and background models, as well as the mass window and number of bins used in the fit. The systematic error is defined as the maximum spread in efficiencies between the modeling variations. The analysis is not sensitive to muon systematics, so, a simplified approach is used in extracting and applying errors in which we apply systematics from 2017 to all three years. The errors are separated by efficiency and the shape of failed probe backgrounds distribution, leading to separations at $|\eta|=1.2$ and $\pt=20$ GeV, respectively. The low- and high-\pt regions included muons with [3,20) GeV and [20,45] GeV. The efficiency shapes between the years are similar and are consistent with centrally available muon systematics for all three years which advocates a streamlined single year systematics approach. The derived systematics are for 2017 data are shown in Table \ref{tab:musyst}.
