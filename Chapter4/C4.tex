\newcommand{\ID}{\text{ID}}
\newcommand{\Prompt}{\text{Prompt}}
\newcommand{\Isolated}{\text{Isolated}}
\newcommand{\Gold}{\text{Gold}}
\newcommand{\Silver}{\text{Silver}}
\newcommand{\Bronze}{\text{Bronze}}



\newcommand\FigureFour[6]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#1}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#2}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#3}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#4}\hfill
\caption{#6}
\label{#5}
\end{figure}}

\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}
\setlength{\parskip}{\smallskipamount}
\setlength{\parindent}{0pt}


\makeatletter


\providecommand{\tabularnewline}{\\}


\makeatother

%\usepackage{babel}
%\begin{document}

\chapter{The Tag-and-Probe}

\begin{chapterabstract}
The tag-and-probe is a method used to measure the selection efficiencies of an object using data. In the context of this compressed SUSY analysis, the Tag-and-probe measures the efficiencies separately of each light lepton selection critera. The total lepton selection efficiency is then computed by combining factorized efficiency components. The same general method is used for both electrons and muons, however, Muons utilize  the $J/\psi$ di-muon trigger which allow direct efficiency measurements from data at lower $p_T$.
\end{chapterabstract}

\section{Introduction and Methodology}
An important element of a lepton based search is properly modeling the efficiency of selected leptons. A purely Monte-Carlo driven approach is inadequate in perfectly describing nuances in data due to imperfections in modeling. Instead of trying to model exactly all physics and detector effects with simulation, the efficiencies can be directly measured from data by using the Tag-and-Probe method. 

The Tag-and-Probe method is used to measure a selection criteria by using a well known resonance such as a $Z$, $J/\psi$, or $\Upsilon$ and counting the number of probes that pass that criteria. Each counted instance of the Tag-and-Probe consists of two selected leptons. One of the selected leptons is the tag and the other is the probe.  The tag passes tight selection requirement to give high confidence that it isn't a fake lepton. Fake leptons fall into two possible categories: reducible and irreducible. A reducible fake lepton is a particle that fakes the signature of a lepton such as a charged pion. An irreducible fake lepton is an actual lepton which coincidentally passes some selection criteria but is not the targeted leptons of interest e.g. an isolated muon from a jet accompanying a leptonic Z decay of interest.  The  second lepton in the Tag-and-Probe is the probe. The probe is subjected to the selection criteria whose efficiency is being measured. The invariant mass of pair of leptons is calculated and required to fall within a defined range around the resonance. A particular event may have multiple lepton pairs but the tag and the probe are not allowed to switch positions and be counted twice, this would lead to a bias in the efficiency measurement \cite(AN 111). To avoid bias the tag and probe are required to be oppositely charged and same flavor with the tag being randomly selected. If multiple pairs can formed in a single event no arbitration is used thus the pair that is not from the resonance will then contribute as combinitorial background. The selected probes can either pass or fail their selection leading to the formation of three distributions, one with a passing probe, one with a failing probe, and one with all probes. The probability of observing $k$ passing probes in $n$ Tag-and-Probe pair trials is dependent on the selection efficiency $\varepsilon$ and can be expressed as a binomial likelihood $P(k|\varepsilon,n) = \binom{n}{k}\varepsilon^k(1-\varepsilon)^{n-k}$. The MLE estimator for efficiency is then the fraction of passing probes from the total number of pairs, or $\varepsilon = k/n$. Technical documentation for the Tag-and-Probe in CMS is scarce, but, an early strategy for fitting efficiency is defined in \cite{Berryhill_2010}. The legacy code base as of \url{CMSSW_10_6_X}  uses a binned maximum likelihood between the observed passing probes and failing probes wher the efficiency extracted is an explicit fit parameter. The two simultaneously fit functions are:
\begin{equation}
	N^{\text{Pass}} = N_{\text{Total}} (\varepsilon \cdot f^{\text{sig}}_{\text{All}} ) +  \varepsilon_{\text{bkg}} \cdot (1-f^{\text{sig} }_{\text{All}}) )
\end{equation} 
\begin{equation}
	N^{\text{Fail}} = N_{\text{Total}} ( (1-\varepsilon) \cdot f^{\text{sig}}_{\text{All}} +   (1-\varepsilon_{\text{bkg}}) \cdot (1-f^{\text{sig}}_{\text{All}}) )
\end{equation}

$N^{\text{Pass/Fail}}$ is the total number of observed probes that either pass or fail the selection criteria while $N_{\text{Total}}$ is the total number of Tag-and-Probe pairs.
The binomial estimator for efficiency, $\varepsilon$, enters the fit functions as the first term but is accompanied by a second term that describes the background contribution with its own efficiency $\varepsilon_{\text{bkg}}$.  The term $f^{\text{sig}}_{\text{All}}$ is the fraction of background subtracted signal events over the allowed dilepton mass range.  $f^{\text{sig}}_{\text{All}}$ depends on the defined signal and background pdfs. The nominal pdfs chosen for reported fits uses a Voigtian+Voigtian signal model combined with an Exponential background model. 

%The distributions are fit simultaneously with a combined signal and background model. To extract the probe criteria efficiecy we divide the resonance distributions by the all probes distribution. The uncertainty on an efficiency is a combination of a statistical and systematic uncertainties. The systematic uncertainties are defined by repeating the simultaneous fit with varying mass windows, number of bins, and fit models and measuring the maximum spread of the central values.


%The fit code is located here: \url{https://github.com/cms-sw/cmssw/blob/CMSSW_10_6_X/PhysicsTools/TagAndProbe/src/TagProbeFitter.cc} around line 600. confirm this with the fit model from the electron paper. \cite{Berryhill_2010}


\section{Lepton Object Definitions}


Leptons are selected according to the minimium requirment 'VeryLoose', the criteria defining VeryLoose is defined in Table \ref{tab:veryloose}.  The set of VeryLoose leptons are further subdivided by quality into three mutually exclusive categories: Gold, Silver, and Bronze. Each category has a measure of three main quantities: the quality of the pre-determined ID (citation about ID here), the "promptness" or distance of the lepton production point from a primary interaction point, and the isolation. Promptness is measured by the significance of the 3D impact parameter whereas the isolation is a measure of the density of particles in a cone around the lepton. Two similar but complimentary, in terms of background rejection, isolations are used: PFIso and MiniIso. Both isolations are an energy sum of neighboring particles inside a cone. PFIso has a fixed cone size of 0.5? and miniIso cone sizes varies inversely with lepton \pt (cite MINIISO)

For miniIso the EA corrections are applied from a centrally provided look up table in bins of pt and eta in the CMSSW Producer/Ntuplizing stage. CITE EA stuff?


The explicit formulas for both electrons and muons can be generalized with the three factorized components previously mentioned:
\begin{equation}\label{eq:efflep_general}
\begin{split}
\epsilon_{\Gold}& = \epsilon_{\ID}\times \epsilon_{\Isolated|\ID} \times \epsilon_{\Prompt|(\ID \cap \Isolated)} \\
\epsilon_{\Silver}& = \epsilon_{\ID} \times \epsilon_{\Isolated|\ID} \times (1-\epsilon_{\Prompt|(\ID \cap \Isolated)}) \\
\epsilon_{\Bronze}& = 1-(\epsilon_{\ID} \times \epsilon_{\Isolated|\ID)} )
\end{split}
\end{equation}

The isolation and vertexing requirements are physically uncorrelated, but there exists intersection between the criteria e.g. a lepton can be prompt and isolated. This intersection then demands the necessity for conditional efficiencies.  The order of the conditional efficiencies is also chosen to minimize the number of measured efficiencies by reusing efficiencies across Gold, Silver, and Bronze.  





\begin{table}[htbp]
\centering
\caption{\label{tab:veryloose} The criteria define the minimum requirements for a lepton accepted. The electron and muon requirements are equivalent in terms of pseudorapidity, vertexing, and isolation but vary in \pt threshold and the MVA VLooseFO working point. The MVA VLooseFO ID is also dependent on year. TODO: REMAKE CAPTION }

\begin{tabular}{c|c|c}
\hline
Criteria & Electron & Muon \\
\hline
\hline
\pt & $\geq 5$ GeV & $\geq 3$ GeV \\

$|\eta|$ & $<2.4$ & $<2.4$ \\
\hline

$\text{IP}_{3D}/\sigma_{\text{IP}_{3D}}$ & $<8$ & $<8$ \\

$|d_{xy}|$ & $<0.05$ cm & $<0.05$ cm \\

$|d_z|$ & $<0.1$ cm & $<0.1$ cm \\

\hline
$\text{PFIso}_{\text{abs}}$ & $<20 + (300/\pt)$ GeV & $<20 + (300/\pt)$ GeV \\

\hline
MVA VLooseFO ID & \checkmark  & --\\
\end{tabular}
\end{table}

\section{Electron Tag-and-Probe }

The electron tag and probe is done by using Z

\section{Muon Tag-and-Probe}

The muon Tag-and-Probe efficiencies are measured above 20 GeV using the Z. Muons below 20 GeV utilize the $J/\psi$ for Id measurements. The $\eta$ bins are divided into a central and forward regions around the endcaps at $|\eta| = 2.1$. In total there are three sets of binnings: The low \pt $J/\psi$ binning $J/\psi^{L}$ used to measure muon Id below 20 GeV, the high \pt Z binning $Z^{H}$ used to measure all efficiencies above 20 GeV, and the low \pt Z binning $Z^{L}$ used to extrapolate isolation and IP efficiencies down to 3 GeV.
The explicit bin edges are:
\begin{itemize}
\item $J/\psi^{L}$  
	\begin{itemize}
		\item[] $p_T \in [3.0, 4.0,  5.0, 6.0, 7.0, 9.0, 14.0,  20.0]$
		\item[]  $\eta| \in [0, 1.2, 2.4]$
	\end{itemize}
\item $Z^{H}$
	\begin{itemize}
		\item[] $ p_T \in [10, 20, 30, 40, 60, 100]$
		\item[] $|\eta| \in [ 0, 1.2, 2.4]$
	\end{itemize}
\item $Z^{L}$
	\begin{itemize}
		\item[] $ p_T \in [6,8,10,14,18,22,28,32,38,44,50]$ 
		\item[] $|\eta| \in [0, 1.2, 2.4]$
	\end{itemize}
\end{itemize}

The isolation and IP criteria are not measured using $J/\psi$ because about $30\%$ of prompt $J/\psi$ are produced from higher mass states $\chi_c$ and $\Psi(2S)$  which implies these $J/\psi$ will be produced inside jets and therefore not necessarily isolated \cite{Lansberg:2006dh}. Similary about $10\%$ of all $J/\psi$ are produced int b-jets and thus potentially neither prompt or isolated \cite{LHCb:2013itw}.

The exact criteria chosen for the tag and probe vary between physics processes but are identical across the two $Z$ ranges. The selections follow the standards defined from the centrally produced muon Tag-and-Probe efficiencies.\\

\begin{tabular}{|c|c|c|}
\hline 
\multicolumn{3}{|c|}{$J/\psi$} \\ 
\hline 
\textbf{Tag} & \multicolumn{2}{c|}{ isGlobalMuon } \\
	& \multicolumn{2}{c|}{ $\pt > 5$ GeV} \\ 
	& \multicolumn{2}{c|}{ numberOfMatchedStations $> 1$} \\
	& \multicolumn{2}{c|}{ Matches hltIterL3MuonCandidates} \\
\hline 
\textbf{Probe} & \multicolumn{2}{c|}{Matches hltTracksIter} \\ 
	  & \multicolumn{2}{c|}{ or } \\
	  & \multicolumn{2}{c|}{Matches hltMuTrackJpsiEffCtfTrackCands } \\
\hline 
\textbf{Pair} & \multicolumn{2}{c|}{$ 2.8 < m_{\ell\ell} < 3.4$} \\
	 & \multicolumn{2}{c|}{$ | z_{\ell_1} - z_{\ell_2} | < 1 $ cm } \\
\hline 
\multicolumn{3}{|c|}{$Z$} \\ 
\hline 
\textbf{Tag} & \multicolumn{2}{c|}{tight ID} \\
			& \multicolumn{2}{c|}{$\pt > 15$ GeV} \\
			& \multicolumn{2}{c|}{ $(\sum p_T^{ch-had})/p_T < 0.2$ } \\
\hline 
\textbf{Probe} & \multicolumn{2}{c|}{No Requirement} \\ 
\hline 
\textbf{Pair} & \multicolumn{2}{c|}{$m_{\ell\ell} > 60$ GeV} \\ 
			  & \multicolumn{2}{c|}{$|z_{\ell_1} - z_{\ell_2}| < 4$ cm} \\
\hline 
\end{tabular} 




For MC there is an inherit difference in the objects selected. Data will also have an implicit selection due to triggering. To account trigger bias and better simulate the behavior of data, tags are required to pass a trigger in the denominator of efficiency for all criteria. The triggers available vary from year to year and are as follows:\\

\begin{tabular}{|c|c|c|}
\hline 
Year & $J/\psi$ & $Z$ \\ 
\hline 
2016 & Mu7p5Tk2 &  IsoTkMu22 \\ 
\hline 
2017 & Mu7p5Tk2 & isoMu24eta2p1 \\ 
\hline 
2018 & Mu7p5Tk2 & isoMu24eta2p1 \\ 
\hline 
\end{tabular} 



 The efficiency factors depend on the range of \pt and are defined as:


\begin{itemize}
\item[] $\pt \in [3,20)$
\end{itemize}
\begin{equation}\label{eq:effcomp_J}
\begin{split}
\epsilon_{\Gold}& = \epsilon_{\ID}^{J/\psi}\times \epsilon_{\Isolated|\ID}^{Z_L} \times \epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_L} \\
\epsilon_{\Silver}& = \epsilon_{\ID}^{J/\psi} \times \epsilon_{\Isolated|\ID}^{Z_L} \times (1-\epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_L}) \\
\epsilon_{\Bronze}& = 1-(\epsilon_{\ID}^{J/\psi} \times \epsilon_{\Isolated|\ID}^{Z_L})
\end{split}
\end{equation}
%\quad \quad \\
\begin{itemize}
\item[] $\pt \in [20,100 ]$
\end{itemize}
\begin{equation}\label{eq:effcomp_Z}
\begin{split}
\epsilon_{\Gold}& = \epsilon_{\ID}^{Z_H}\times\epsilon_{\Isolated|\ID}^{Z_H}\times\epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_H} \\
\epsilon_{\Silver}& = \epsilon_{\ID}^{Z_H}\times\epsilon_{\Isolated|\ID}^{Z_H}\times(1-\epsilon_{\Prompt|(\ID \cap \Isolated)}^{Z_H})\\
\epsilon_{\Bronze}& = 1-(\epsilon_{\ID}^{Z_H} \times \epsilon_{\Isolated|\ID}^{Z_H})
\end{split}
\end{equation}

 The ID efficiency with statistical errors for both data and MC are shown in Figure \ref{fig:jpsiZ17-ideff-ratio}. The other efficiencies for each year for all \pt ranges are included in the appendix. The overlapping bins between $J/\psi$ and $Z$ do not all match within statistical uncertainties. However, the average deviation of the efficiency central values are $0.02\%$ for MC and $1\%$ for data.  



The extrapolation of the vertexing and isolation efficiencies below 20 GeV is done by fitting a quadratic polynomial to the efficiencies on the $Z_L$ interval.  Both data and MC are shown in Figure \ref{fig:eff17-extraps}.  The errors for each bin are the combined statistical and systematic errors from Table \ref{tab:musyst} and are adjusted before the polynomial fit. Any efficiencies below 20 GeV are then reported from the fit model. The fit errors are the 68\% confidence interval combined with the systematic errors. The worst observed P-value is $\approx 2\%$ but most of the fits are high quality.

The very loose and the efficiency components combined into Gold, Silver, and Bronze are summarized in Figure \ref{fig:2017-mu1-gsbvl}, the other years are included in the appendix. The tool used to store/calculate efficiencies can be found at \url{https://github.com/Jphsx/LepTool}.  The cumulative efficiency for a muon also includes the efficiency of the VeryLoose selection and is defined as:
\begin{equation}
\epsilon_\mu = \epsilon_{\text{VeryLoose}} \times \epsilon_{\text{Gold/Silver/Bronze}}
\end{equation}

\newcommand\FigureTwo[4]{%
\begin{figure}[!htbp]%
\centering
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#1}\hfill
\includegraphics[width=0.5\textwidth]{fig/Lep_Obj_plots/#2}\hfill
\caption{#4}
\label{#3}
\end{figure}}

\FigureFour{canvas0J2017b.pdf}{canvas1J2017e.pdf}%
           {canvas0Z2017b.pdf}{canvas1Z2017e.pdf}%
          {fig:jpsiZ17-ideff-ratio}{Tag-and-Probe efficiencies for the Medium Id in 2017. The left plots show the barrel while the right plots show the endcaps. The top fits use $J/\psi$ resonance while the bottom use the Z resonance. }

\FigureTwo{effFit_2.pdf}{effFit_5.pdf}%
          {fig:eff17-extraps}{The fitted muon isolation and SIP3D efficiencies for 2017. Includes both data and MC which are separated between barrel and endcap.  }



\FigureFour{h_2017_1.pdf}{h_2017_2.pdf}
		   {h_2017_3.pdf}{h_2017_0.pdf}
		   {fig:2017-mu1-gsbvl}{The combined efficiency components from equations \ref{eq:effcomp_J} and \ref{eq:effcomp_Z} and Very Loose for 2017. The low-\pt region ($<20$ GeV) includes the contributions from $J/\psi$ as well as the isolation and SIP3D extrapolations. Propagated errors are treated as uncorrelated.}


\section{Lepton Systematics}

The systematic error for the muon efficiencies is derived by varying the Tag-and-Probe signal and background models, as well as the mass window and number of bins used in the fit. The systematic error is defined as the maximum spread in efficiencies between the modeling variations. The analysis is not sensitive to muon systematics, so, a simplified approach is used in extracting and applying errors in which we apply systematics from 2017 to all three years. The errors are separated by efficiency and the shape of failed probe backgrounds distribution, leading to separations at $|\eta|=1.2$ and $\pt=20$ GeV, respectively. The low- and high-\pt regions included muons with [3,20) GeV and [20,45] GeV. The efficiency shapes between the years are similar and are consistent with centrally available muon systematics for all three years which advocates a streamlined single year systematics approach. The derived systematics are for 2017 data are shown in Table \ref{tab:musyst}.
